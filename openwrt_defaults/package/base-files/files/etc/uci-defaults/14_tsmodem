#!/bin/sh

uci -q batch <<-EOF
    set network.loopback=interface
    set network.loopback.device='lo'
    set network.loopback.proto='static'
    set network.loopback.ipaddr='127.0.0.1'
    set network.loopback.netmask='255.0.0.0'
    set network.loopback.ifname='lo'
    set network.globals=globals
    set network.globals.ula_prefix='fd65:1e12:de67::/48'
    set network.lan=interface
    set network.lan.device='br-lan'
    set network.lan.proto='static'
    set network.lan.ipaddr='192.168.1.1'
    set network.lan.netmask='255.255.255.0'
    set network.lan.ip6assign='60'
    set network.lan.dns='8.8.8.8'
    set network.lan.ip4table='default'
    set network.lan.ip6table='default'
    set network.@switch[0]=switch
    set network.@switch[0].name='switch0'
    set network.@switch[0].reset='1'
    set network.@switch[0].enable_vlan='1'
    set network.@switch_vlan[0]=switch_vlan
    set network.@switch_vlan[0].device='switch0'
    set network.@switch_vlan[0].vlan='1'
    set network.@switch_vlan[0].ports='1 2 3 4 6t'
    set network.@switch_vlan[1]=switch_vlan
    set network.@switch_vlan[1].device='switch0'
    set network.@switch_vlan[1].vlan='2'
    set network.@switch_vlan[1].ports='0 6t'
    set network.tsmodem=interface
    set network.tsmodem.username='root'
    set network.tsmodem.proto='3g'
    set network.tsmodem.device='/dev/ttyUSB2'
    set network.tsmodem.dialnumber='*99***1#'
    set network.tsmodem.service='umts'
    set network.tsmodem.pppd_options='noipdefault'
    set network.tsmodem.keepalive='500 5'
    set network.tsmodem.apn='internet.mts.ru'
    set network.tsmodem.ipv6='auto'
    set network.tsmodem.ip4table='default'
    set network.tsmodem.ip6table='default'
    set network.@device[0]=device
    set network.@device[0].name='br-lan'
    set network.@device[0].type='bridge'
    set network.@device[0].ports='3g-tsmodem' 'erspan0' 'eth0' 'eth0.1' 'eth0.2'
    set network.@device[1]=device
    set network.@device[1].name='3g-tsmodem'
    set network.@device[2]=device
    set network.@device[2].name='eth0'
    set network.@device[3]=device
    set network.@device[3].name='eth0.1'
    set network.@device[3].type='8021q'
    set network.@device[3].ifname='eth0'
    set network.@device[3].vid='1'
    set network.@device[4]=device
    set network.@device[4].name='eth0.2'
    set network.@device[4].type='8021q'
    set network.@device[4].ifname='eth0'
    set network.@device[4].vid='2'
    set network.wan_eth0_2_dev=device
    set network.wan_eth0_2_dev.name='eth0.2'
    set network.wan_eth0_2_dev.macaddr='30:eb:1f:14:fa:97'
    set network.wifi=interface
    set network.wifi.proto='static'
    set network.wifi.device='phy0-ap0'
    set network.wifi.ipaddr='192.168.2.1'
    set network.wifi.netmask='255.255.255.0'
    set network.wifi.ip4table='default'
    set network.wifi.ip6table='default'
    commit network
EOF

uci -q batch <<-EOF
    set dhcp.@dnsmasq[0]=dnsmasq
    set dhcp.@dnsmasq[0].domainneeded='1'
    set dhcp.@dnsmasq[0].boguspriv='1'
    set dhcp.@dnsmasq[0].filterwin2k='0'
    set dhcp.@dnsmasq[0].localise_queries='1'
    set dhcp.@dnsmasq[0].rebind_protection='1'
    set dhcp.@dnsmasq[0].rebind_localhost='1'
    set dhcp.@dnsmasq[0].local='/lan/'
    set dhcp.@dnsmasq[0].domain='lan'
    set dhcp.@dnsmasq[0].expandhosts='1'
    set dhcp.@dnsmasq[0].nonegcache='0'
    set dhcp.@dnsmasq[0].cachesize='1000'
    set dhcp.@dnsmasq[0].authoritative='1'
    set dhcp.@dnsmasq[0].readethers='1'
    set dhcp.@dnsmasq[0].leasefile='/tmp/set dhcp.leases'
    set dhcp.@dnsmasq[0].resolvfile='/tmp/resolv.conf.d/resolv.conf.auto'
    set dhcp.@dnsmasq[0].nonwildcard='1'
    set dhcp.@dnsmasq[0].localservice='1'
    set dhcp.@dnsmasq[0].ednspacket_max='1232'
    set dhcp.@dnsmasq[0].filter_aaaa='0'
    set dhcp.@dnsmasq[0].filter_a='0'
    set dhcp.lan=dhcp
    set dhcp.lan.interface='lan'
    set dhcp.lan.start='100'
    set dhcp.lan.limit='150'
    set dhcp.lan.leasetime='12h'
    set dhcp.lan.dhcpv4='server'
    set dhcp.lan.dhcpv6='server'
    set dhcp.lan.ra='server'
    set dhcp.lan.ra_flags='managed-config' 'other-config'
    set dhcp.lan.ignore='1'
    set dhcp.odhcpd=odhcpd
    set dhcp.odhcpd.maindhcp='0'
    set dhcp.odhcpd.leasefile='/tmp/hosts/odhcpd'
    set dhcp.odhcpd.leasetrigger='/usr/sbin/odhcpd-update'
    set dhcp.odhcpd.loglevel='4'
    set dhcp.tsmodem=dhcp
    set dhcp.tsmodem.interface='tsmodem'
    set dhcp.wifi=dhcp
    set dhcp.wifi.interface='wifi'
    set dhcp.wifi.start='100'
    set dhcp.wifi.limit='150'
    set dhcp.wifi.leasetime='12h'
    commit dhcp
EOF

uci -q batch <<-EOF >/dev/null
    set system.@system[0].hostname='BITCORD-RTR-2'
    set system.@system[0].pubname='Роутер BITCORD RTR-2'
    set system.@system[0].timezone='MSK-3'
    set system.@system[0].zonename='Europe/Moscow'
    commit system
    set wireless.radio0=wifi-device
    set wireless.radio0.type='mac80211'
    set wireless.radio0.path='platform/10300000.wmac'
    set wireless.radio0.channel='1'
    set wireless.radio0.band='2g'
    set wireless.radio0.htmode='HT20'
    set wireless.radio0.cell_density='1'
    set wireless.default_radio0=wifi-iface
    set wireless.default_radio0.device='radio0'
    set wireless.default_radio0.network='wwan wifi'
    set wireless.default_radio0.mode='ap'
    set wireless.default_radio0.ssid='BITCORD-RTR-2'
    set wireless.default_radio0.encryption='psk2'
    set wireless.default_radio0.key='WFCLokm7Ls'
    commit wireless
    set firewall.@defaults[0]=defaults
    set firewall.@defaults[0].input='ACCEPT'
    set firewall.@defaults[0].output='ACCEPT'
    set firewall.@defaults[0].forward='ACCEPT'
    set firewall.@defaults[0].synflood_protect='1'
    set firewall.@zone[0]=zone
    set firewall.@zone[0].name='lan'
    set firewall.@zone[0].input='ACCEPT'
    set firewall.@zone[0].output='ACCEPT'
    set firewall.@zone[0].forward='ACCEPT'
    set firewall.@zone[0].masq='1'
    set firewall.@zone[0].device='3g-tsmodem' 'br-lan' 'erspan0' 'eth0' 'eth0.1' 'eth0.2' 'phy0-ap0' 'radio0.network1'
    set firewall.@zone[0].network='lan' 'tsmodem' 'wifi'
    set firewall.@zone[1]=zone
    set firewall.@zone[1].name='3g'
    set firewall.@zone[1].input='ACCEPT'
    set firewall.@zone[1].output='ACCEPT'
    set firewall.@zone[1].forward='ACCEPT'
    set firewall.@zone[1].network='lan' 'tsmodem' 'wifi'
    set firewall.@forwarding[0]=forwarding
    set firewall.@forwarding[0].src='lan'
    set firewall.@forwarding[0].dest='3g'
    set firewall.@forwarding[1]=forwarding
    set firewall.@forwarding[1].src='3g'
    set firewall.@forwarding[1].dest='lan'
    commit firewall
    set luci.main.lang='ru'
    set luci.ccache.enable='0'
    commit luci
EOF

VDATE=$(opkg info tsmodem | grep Version | awk '{
    print substr($0,10,10)
}')

VNUM=$(opkg info tsmodem | grep Version | awk '{
    print substr($0,30,10)
}')

uci set tsmodem.version.number=$VNUM
uci set tsmodem.version.date=$VDATE
uci commit tsmodem

exit 0
